<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Cloud Shadow Masking for Flat Terrain — cloudShadowMask • RStoolbox</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Cloud Shadow Masking for Flat Terrain — cloudShadowMask"><meta name="description" content="Intended for interactive use, cloudShadowMask will ask the user to select a few
corresponding cloud/cloudShadow pixels which will be used to estimate coordinates
for a linear cloudmask shift."><meta property="og:description" content="Intended for interactive use, cloudShadowMask will ask the user to select a few
corresponding cloud/cloudShadow pixels which will be used to estimate coordinates
for a linear cloudmask shift."><meta property="og:image" content="https://bleutner.github.io/RStoolbox/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RStoolbox</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="external-link nav-link" href="http://www.github.com/bleutner"><span class="fa fa-github fa-lg fab"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Cloud Shadow Masking for Flat Terrain</h1>
      <small class="dont-index">Source: <a href="https://github.com/bleutner/RStoolbox/blob/master/R/cloudMask.R" class="external-link"><code>R/cloudMask.R</code></a></small>
      <div class="d-none name"><code>cloudShadowMask.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Intended for interactive use, <code>cloudShadowMask</code> will ask the user to select a few
corresponding cloud/cloudShadow pixels which will be used to estimate coordinates
for a linear cloudmask shift.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">cloudShadowMask</span><span class="op">(</span></span>
<span>  <span class="va">img</span>,</span>
<span>  <span class="va">cm</span>,</span>
<span>  nc <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  shiftEstimate <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  preciseShift <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  quantile <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  returnShift <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-img">img<a class="anchor" aria-label="anchor" href="#arg-img"></a></dt>
<dd><p>SpatRaster containing the scene</p></dd>


<dt id="arg-cm">cm<a class="anchor" aria-label="anchor" href="#arg-cm"></a></dt>
<dd><p>SpatRaster. Cloud mask (typically the result of <code><a href="cloudMask.html">cloudMask</a></code>)</p></dd>


<dt id="arg-nc">nc<a class="anchor" aria-label="anchor" href="#arg-nc"></a></dt>
<dd><p>Integer. Number of control points. A few points (default) are fine because the final shift is estimated by <a href="coregisterImages.html">coregisterImages</a>.</p></dd>


<dt id="arg-shiftestimate">shiftEstimate<a class="anchor" aria-label="anchor" href="#arg-shiftestimate"></a></dt>
<dd><p>NULL or numeric vector of length two (x,y). Estimated displacement of shadows in map units. If <code>NULL</code>, the user will be asked to select control points interactively.</p></dd>


<dt id="arg-preciseshift">preciseShift<a class="anchor" aria-label="anchor" href="#arg-preciseshift"></a></dt>
<dd><p>NULL or numeric vector of length two (x,y). Use this if cloud/cloud-shadow displacement is already known, e.g. from a previous run of <code>cloudShadowMask</code>.</p></dd>


<dt id="arg-quantile">quantile<a class="anchor" aria-label="anchor" href="#arg-quantile"></a></dt>
<dd><p>Numeric (between 0 and 1). Quantile threshold used for image co-registration. By default the 20% quantile of the total intensity (sum) of the image is used as potential shadow mask.</p></dd>


<dt id="arg-returnshift">returnShift<a class="anchor" aria-label="anchor" href="#arg-returnshift"></a></dt>
<dd><p>Logical. Return a numeric vector containing the shift parameters. Useful if you estimate parameters on a subset of the image.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>Returns a RasterLayer with the cloud shadow mask (0 = shadow, NA = not-shadow).</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This is a very simplistic approach to cloud shadow masking (simple shift of the cloud mask). It is not image based and accuracy will suffer from clouds at different altitudes. However, just as cloudMask
this is a quick and easy to use tool for Landsat data if you're just working on a few scenes and don't have fMask or CDR data at hand. Although for some test scenes
it does perform surprisingly well.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><a href="cloudMask.html">cloudMask</a></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## Import Landsat example subset</span></span></span>
<span class="r-in"><span><span class="co">## We have two tiny clouds in the east</span></span></span>
<span class="r-in"><span><span class="fu"><a href="ggRGB.html">ggRGB</a></span><span class="op">(</span><span class="va">lsat</span>, stretch <span class="op">=</span> <span class="st">"lin"</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="cloudShadowMask-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Calculate cloud index</span></span></span>
<span class="r-in"><span><span class="va">cldmsk</span>    <span class="op">&lt;-</span> <span class="fu"><a href="cloudMask.html">cloudMask</a></span><span class="op">(</span><span class="va">lsat</span>, blue <span class="op">=</span> <span class="fl">1</span>, tir <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="ggR.html">ggR</a></span><span class="op">(</span><span class="va">cldmsk</span>, <span class="fl">2</span>, geom_raster <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span></span>
<span class="r-plt img"><img src="cloudShadowMask-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Define threshold (re-use the previously calculated index)</span></span></span>
<span class="r-in"><span><span class="co">## Everything above the threshold is masked</span></span></span>
<span class="r-in"><span><span class="co">## In addition we apply a region-growing around the core cloud pixels</span></span></span>
<span class="r-in"><span><span class="va">cldmsk_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="cloudMask.html">cloudMask</a></span><span class="op">(</span><span class="va">cldmsk</span>, threshold <span class="op">=</span> <span class="fl">0.1</span>, buffer <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> </span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Plot cloudmask </span></span></span>
<span class="r-in"><span><span class="fu"><a href="ggRGB.html">ggRGB</a></span><span class="op">(</span><span class="va">lsat</span>, stretch <span class="op">=</span> <span class="st">"lin"</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>   <span class="fu"><a href="ggR.html">ggR</a></span><span class="op">(</span><span class="va">cldmsk_final</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, ggLayer <span class="op">=</span> <span class="cn">TRUE</span>, forceCat <span class="op">=</span> <span class="cn">TRUE</span>, geom_raster <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span><span class="op">)</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Removed 88752 rows containing missing values or values outside the scale range</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> (`geom_raster()`).</span>
<span class="r-plt img"><img src="cloudShadowMask-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#' ## Estimate cloud shadow displacement</span></span></span>
<span class="r-in"><span><span class="co">## Interactively (click on cloud pixels and the corresponding shadow pixels)</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span>  <span class="va">shadow</span> <span class="op">&lt;-</span> <span class="fu">cloudShadowMask</span><span class="op">(</span><span class="va">lsat</span>, <span class="va">cldmsk_final</span>, nc <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>  <span class="co"># \dontrun{}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Non-interactively. Pre-defined shadow displacement estimate (shiftEstimate)</span></span></span>
<span class="r-in"><span><span class="va">shadow</span> <span class="op">&lt;-</span> <span class="fu">cloudShadowMask</span><span class="op">(</span><span class="va">lsat</span>, <span class="va">cldmsk_final</span>, shiftEstimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">16</span>,<span class="op">-</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Plot</span></span></span>
<span class="r-in"><span><span class="va">csmask</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">cldmsk_final</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">shadow</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="ggRGB.html">ggRGB</a></span><span class="op">(</span><span class="va">lsat</span>, stretch <span class="op">=</span> <span class="st">"lin"</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>        <span class="fu"><a href="ggR.html">ggR</a></span><span class="op">(</span><span class="va">csmask</span>, ggLayer <span class="op">=</span> <span class="cn">TRUE</span>, forceCat <span class="op">=</span> <span class="cn">TRUE</span>, geom_raster <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"yellow"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"shadow"</span>, <span class="st">"cloud"</span><span class="op">)</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Removed 88534 rows containing missing values or values outside the scale range</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> (`geom_raster()`).</span>
<span class="r-plt img"><img src="cloudShadowMask-4.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Benjamin Leutner, Ned Horning, Jakob Schwalb-Willmann, Konstantin Mueller.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

