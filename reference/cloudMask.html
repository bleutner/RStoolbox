<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Simple Cloud Detection — cloudMask • RStoolbox</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simple Cloud Detection — cloudMask"><meta name="description" content="Developed for use with Landsat data cloudMask relies on the distinctive difference between the blue (or any other short-wave band)
and thermal band for semi-automated creation of a cloud mask. Since it relies on thermal information it doesn't work well for sensors without
thermal bands."><meta property="og:description" content="Developed for use with Landsat data cloudMask relies on the distinctive difference between the blue (or any other short-wave band)
and thermal band for semi-automated creation of a cloud mask. Since it relies on thermal information it doesn't work well for sensors without
thermal bands."><meta property="og:image" content="https://bleutner.github.io/RStoolbox/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RStoolbox</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="external-link nav-link" href="http://www.github.com/bleutner"><span class="fa fa-github fa-lg fab"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Simple Cloud Detection</h1>
      <small class="dont-index">Source: <a href="https://github.com/bleutner/RStoolbox/blob/master/R/cloudMask.R" class="external-link"><code>R/cloudMask.R</code></a></small>
      <div class="d-none name"><code>cloudMask.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Developed for use with Landsat data <code>cloudMask</code> relies on the distinctive difference between the blue (or any other short-wave band)
and thermal band for semi-automated creation of a cloud mask. Since it relies on thermal information it doesn't work well for sensors without
thermal bands.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">cloudMask</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  blue <span class="op">=</span> <span class="st">"B1_sre"</span>,</span>
<span>  tir <span class="op">=</span> <span class="st">"B6_sre"</span>,</span>
<span>  buffer <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  plot <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">verbose</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>SpatRaster with reflectance and brightness temperature OR the mask of a previous run of <code>cloudMask</code> with <code>returnDiffLayer=TRUE</code>.</p></dd>


<dt id="arg-threshold">threshold<a class="anchor" aria-label="anchor" href="#arg-threshold"></a></dt>
<dd><p>Numeric. cloud detection threshold. If not provided it will be guessed. Everything *below* this threshold will be considered a cloud pixel (unless it is removed by filtering afterwards).</p></dd>


<dt id="arg-blue">blue<a class="anchor" aria-label="anchor" href="#arg-blue"></a></dt>
<dd><p>Character or integer. Bandname or number for the blue band</p></dd>


<dt id="arg-tir">tir<a class="anchor" aria-label="anchor" href="#arg-tir"></a></dt>
<dd><p>Character or integer. Bandname or number for the thermal band</p></dd>


<dt id="arg-buffer">buffer<a class="anchor" aria-label="anchor" href="#arg-buffer"></a></dt>
<dd><p>Integer. Number of pixels to use as a buffer that will be added to the identified cloud centers.</p></dd>


<dt id="arg-plot">plot<a class="anchor" aria-label="anchor" href="#arg-plot"></a></dt>
<dd><p>Logical. Plots of the cloud mask for all sub-steps (sanitizing etc.) Helpful to find proper parametrization.</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>Logical. Print messages or suppress.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>Returns a SpatRaster with two layers: CMASK contains the binary cloud mask (1 = cloud, NA = not-cloud) and NDTCI contains the cloud index.</p>
    </div>
    <div class="section level2">
    <h2 id="note">Note<a class="anchor" aria-label="anchor" href="#note"></a></h2>
    <p>Typically clouds are cold in the thermal region and have high reflectance in short wavelengths (blue). By calculating a normalized difference index between the two bands and thresholding a rough cloud mask can be obtained.
Before calculating the spectral cloud index (let's call it Normalized Difference Thermal Cloud Index (NDTCI)) the thermal band will be matched to the same value range as the blue band. Therefore, it doesn't matter whether you
provide DN, radiance or brightness temperature.</p>
<p>This approach to cloud masking is very simplistic. And aims only at rough removal of potentially clouded areas. Nevertheless, it is able to provide satisfactory results.
More sophisticated approaches, including cloud cast shadow detection can be found elsewhere, e.g. <a href="https://code.google.com/archive/p/fmask" class="external-link">fmask</a>.</p>
<p>It can make sense to find a suitable threshold on a cropped version of the scene. Also make sure you make use of the <code>returnDiffLayer</code> argument to save yourself one processing step.
Buffering should be seen as final polishing, i.e. as long as the pure cloud centers are not detected properly, you might want to turn it off. since it takes some time to calculate.
Once your mask detects obvious cloud pixels properly re-enable buffering for fine tuning if desired. Finally, once a suitable threshold is established re-run cloudMask on the whole scene with this threshold and go get a coffee.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="cloudShadowMask.html">cloudShadowMask</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## Import Landsat example subset</span></span></span>
<span class="r-in"><span><span class="co">## We have two tiny clouds in the east</span></span></span>
<span class="r-in"><span><span class="fu"><a href="ggRGB.html">ggRGB</a></span><span class="op">(</span><span class="va">lsat</span>, stretch <span class="op">=</span> <span class="st">"lin"</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="cloudMask-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Calculate cloud index</span></span></span>
<span class="r-in"><span><span class="va">cldmsk</span>    <span class="op">&lt;-</span> <span class="fu">cloudMask</span><span class="op">(</span><span class="va">lsat</span>, blue <span class="op">=</span> <span class="fl">1</span>, tir <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="ggR.html">ggR</a></span><span class="op">(</span><span class="va">cldmsk</span>, <span class="fl">2</span>, geom_raster <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span></span>
<span class="r-plt img"><img src="cloudMask-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Define threshold (re-use the previously calculated index)</span></span></span>
<span class="r-in"><span><span class="co">## Everything above the threshold is masked</span></span></span>
<span class="r-in"><span><span class="co">## In addition we apply a region-growing around the core cloud pixels</span></span></span>
<span class="r-in"><span><span class="va">cldmsk_final</span> <span class="op">&lt;-</span> <span class="fu">cloudMask</span><span class="op">(</span><span class="va">cldmsk</span>, threshold <span class="op">=</span> <span class="fl">0.1</span>, buffer <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> </span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Plot cloudmask </span></span></span>
<span class="r-in"><span><span class="fu"><a href="ggRGB.html">ggRGB</a></span><span class="op">(</span><span class="va">lsat</span>, stretch <span class="op">=</span> <span class="st">"lin"</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>   <span class="fu"><a href="ggR.html">ggR</a></span><span class="op">(</span><span class="va">cldmsk_final</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, ggLayer <span class="op">=</span> <span class="cn">TRUE</span>, forceCat <span class="op">=</span> <span class="cn">TRUE</span>, geom_raster <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span><span class="op">)</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Removed 88752 rows containing missing values or values outside the scale range</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> (`geom_raster()`).</span>
<span class="r-plt img"><img src="cloudMask-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#' ## Estimate cloud shadow displacement</span></span></span>
<span class="r-in"><span><span class="co">## Interactively (click on cloud pixels and the corresponding shadow pixels)</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span>  <span class="va">shadow</span> <span class="op">&lt;-</span> <span class="fu"><a href="cloudShadowMask.html">cloudShadowMask</a></span><span class="op">(</span><span class="va">lsat</span>, <span class="va">cldmsk_final</span>, nc <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>  <span class="co"># \dontrun{}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Non-interactively. Pre-defined shadow displacement estimate (shiftEstimate)</span></span></span>
<span class="r-in"><span><span class="va">shadow</span> <span class="op">&lt;-</span> <span class="fu"><a href="cloudShadowMask.html">cloudShadowMask</a></span><span class="op">(</span><span class="va">lsat</span>, <span class="va">cldmsk_final</span>, shiftEstimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">16</span>,<span class="op">-</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Plot</span></span></span>
<span class="r-in"><span><span class="va">csmask</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">cldmsk_final</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">shadow</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="ggRGB.html">ggRGB</a></span><span class="op">(</span><span class="va">lsat</span>, stretch <span class="op">=</span> <span class="st">"lin"</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>        <span class="fu"><a href="ggR.html">ggR</a></span><span class="op">(</span><span class="va">csmask</span>, ggLayer <span class="op">=</span> <span class="cn">TRUE</span>, forceCat <span class="op">=</span> <span class="cn">TRUE</span>, geom_raster <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"yellow"</span><span class="op">)</span>, </span></span>
<span class="r-in"><span>        labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"shadow"</span>, <span class="st">"cloud"</span><span class="op">)</span>, na.value <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>Removed 88534 rows containing missing values or values outside the scale range</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> (`geom_raster()`).</span>
<span class="r-plt img"><img src="cloudMask-4.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Benjamin Leutner, Ned Horning, Jakob Schwalb-Willmann, Konstantin Mueller.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

